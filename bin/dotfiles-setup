#!/usr/bin/env bash
#
# dotfiles-setup - One-time setup script for dotfiles
#

set -o errexit
set -o nounset
set -o pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOTFILES_DIR="$(dirname "${SCRIPT_DIR}")"

# Colors
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $*"; }
log_success() { echo -e "${GREEN}[✓]${NC} $*"; }
log_warning() { echo -e "${YELLOW}[⚠]${NC} $*"; }
log_error() { echo -e "${RED}[✗]${NC} $*"; }

main() {
    echo ""
    log_info "Dotfiles Setup"
    echo ""

    # Detect shell
    local shell_type
    case "${SHELL}" in
        */bash) shell_type="bash" ;;
        */zsh) shell_type="zsh" ;;
        *)
            log_error "Unsupported shell: ${SHELL}"
            exit 1
            ;;
    esac

    log_info "Detected shell: ${shell_type}"

    # Create ~/.dotfiles runtime directory structure
    log_info "Setting up ~/.dotfiles runtime directory..."

    # Create base directories
    mkdir -p "${HOME}/.dotfiles/shell/bash/modules.d"
    mkdir -p "${HOME}/.dotfiles/shell/zsh/modules.d"
    mkdir -p "${HOME}/.dotfiles/state"
    mkdir -p "${HOME}/.dotfiles/config"

    # Copy init.sh files from repo to runtime location
    log_info "Copying shell initialization files..."
    cp "${DOTFILES_DIR}/shell/bash/init.sh" "${HOME}/.dotfiles/shell/bash/init.sh"
    cp "${DOTFILES_DIR}/shell/zsh/init.sh" "${HOME}/.dotfiles/shell/zsh/init.sh"

    log_success "Runtime directory structure created"

    # Add dotfiles init to shell RC file
    local shell_rc="${HOME}/.${shell_type}rc"
    local init_line="[[ -f \"\${HOME}/.dotfiles/shell/${shell_type}/init.sh\" ]] && source \"\${HOME}/.dotfiles/shell/${shell_type}/init.sh\""

    if [[ ! -f "${shell_rc}" ]]; then
        log_info "Creating ${shell_rc}..."
        touch "${shell_rc}"
    fi

    if grep -Fxq "${init_line}" "${shell_rc}" 2>/dev/null; then
        log_success "Shell integration already configured in ${shell_rc}"
    else
        log_info "Adding dotfiles initialization to ${shell_rc}..."
        echo "" >> "${shell_rc}"
        echo "# Dotfiles" >> "${shell_rc}"
        echo "${init_line}" >> "${shell_rc}"
        log_success "Shell integration configured"
    fi

    # Add dotfiles bin to PATH in current session
    export PATH="${DOTFILES_DIR}/bin:${PATH}"

    echo ""
    log_success "Setup complete!"
    echo ""
    log_info "Next steps:"
    log_info "  1. Run: source ~/.${shell_type}rc"
    log_info "  2. Run: dotfiles install"
    log_info "  3. Run: dotfiles doctor"
    echo ""
    log_info "Or simply run: make install"
    echo ""
}

main "$@"
